#!/bin/bash

PKI_DIR="/etc/openvpn/pki"
CONFIG_FILE="/opt/configuration/set_defaults.sh"

# Source the configuration file to get USE_CLIENT_CERTIFICATE
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
    echo "Error: Configuration file not found." >&2
    exit 1
fi

if [ "$USE_CLIENT_CERTIFICATE" != "true" ]; then
    echo "Error: Client certificates are not in use (USE_CLIENT_CERTIFICATE is not set to 'true')." >&2
    echo "User list is not applicable in this configuration." >&2
    exit 1
fi

if [ ! -d "$PKI_DIR/issued" ]; then
    echo "Error: Certificate directory not found." >&2
    exit 1
fi

echo "List of OpenVPN users:"
echo "---------------------"

for cert in "$PKI_DIR/issued"/*.crt; do
    if [ -f "$cert" ]; then
        username=$(basename "$cert" .crt)
        if [ "$username" != "server" ] && [ "$username" != "ca" ]; then
            echo "$username"
        fi
    fi
done
